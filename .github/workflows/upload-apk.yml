name: Auto Upload APK to Release

on:
  push:
    paths:
      - '*.apk'  # ูุนูู ุนูุฏ ุฅุถุงูุฉ ุฃู ููู APK ูู ุฌุฐุฑ ุงููุณุชูุฏุน

jobs:
  upload:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # ููุญุตูู ุนูู ุงูุชุบููุฑุงุช ุงูุฃุฎูุฑุฉ

      - name: ุงูุชุดุงู ูููุงุช APK ุงูุฌุฏูุฏุฉ
        id: detect
        run: |
          # ุงูุจุญุซ ุนู ุฌููุน ูููุงุช APK ูู ุฌุฐุฑ ุงููุณุชูุฏุน
          APK_FILES=$(find . -maxdepth 1 -name "*.apk" -type f)
          
          if [ -z "$APK_FILES" ]; then
            echo "โน๏ธ ูุง ุชูุฌุฏ ูููุงุช APK ูู ุฌุฐุฑ ุงููุณุชูุฏุน"
            echo "has_apk=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "has_apk=true" >> $GITHUB_OUTPUT
          
          # ุญูุธ ูุงุฆูุฉ ุงููููุงุช
          echo "$APK_FILES" > apk_list.txt
          
          echo "โ ุชู ุงูุชุดุงู ุงููููุงุช ุงูุชุงููุฉ:"
          cat apk_list.txt

      - name: ุฑูุน ูู ููู APK ุฅูู Release ูููุตู
        if: steps.detect.outputs.has_apk == 'true'
        run: |
          while IFS= read -r APK_FILE; do
            # ุฅุฒุงูุฉ ./ ูู ุงูุจุฏุงูุฉ
            APK_FILE=${APK_FILE#./}
            
            # ุงูุญุตูู ุนูู ุงุณู ุงูููู ุจุฏูู ุงููุณุงุฑ
            FILENAME=$(basename "$APK_FILE")
            
            # ุงูุญุตูู ุนูู ุงุณู ุงูุฅุตุฏุงุฑ (ุงุณู ุงูููู ุจุฏูู .apk)
            RELEASE_NAME="${FILENAME%.apk}"
            
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
            echo "๐ฆ ูุนุงูุฌุฉ: $FILENAME"
            echo "๐ท๏ธ ุงุณู ุงูุฅุตุฏุงุฑ: $RELEASE_NAME"
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
            
            # ุงูุชุญูู ูู ููุน ุงูููู
            echo "๐ ุงูุชุญูู ูู ููุน ุงูููู..."
            file "$APK_FILE"
            
            if ! head -c 4 "$APK_FILE" | grep -q "PK"; then
              echo "โ๏ธ ุชุญุฐูุฑ: $FILENAME ูุฏ ูุง ูููู APK ุตุญูุญุ ุณูุชู ุชุฎุทูู"
              continue
            fi
            
            # ุงูุญุตูู ุนูู ุญุฌู ุงูููู
            FILE_SIZE=$(stat -c%s "$APK_FILE" 2>/dev/null)
            echo "๐ ุญุฌู ุงูููู: $FILE_SIZE ุจุงูุช"
            
            if [ "$FILE_SIZE" -lt 1000 ]; then
              echo "โ ุงูููู ุตุบูุฑ ุฌุฏุงูุ ุณูุชู ุชุฎุทูู"
              continue
            fi
            
            # ุงูุชุญูู ูู ูุฌูุฏ ุงูุฅุตุฏุงุฑ ูุงูููู ุงููุฏูู
            echo "๐ ุงูุจุญุซ ุนู ุฅุตุฏุงุฑ ุณุงุจู..."
            RELEASE_ID=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/${{ github.repository }}/releases/tags/$RELEASE_NAME" \
              | jq -r '.id')
            
            if [ "$RELEASE_ID" != "null" ] && [ -n "$RELEASE_ID" ]; then
              echo "โ ุชู ุงูุนุซูุฑ ุนูู ุฅุตุฏุงุฑ ุณุงุจู: $RELEASE_ID"
              
              # ุงูุจุญุซ ุนู ุงูููู ุงููุฏูู ุจููุณ ุงูุงุณู
              ASSET_ID=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                "https://api.github.com/repos/${{ github.repository }}/releases/$RELEASE_ID/assets" \
                | jq -r ".[] | select(.name==\"$FILENAME\") | .id")
              
              if [ -n "$ASSET_ID" ] && [ "$ASSET_ID" != "null" ]; then
                echo "๐๏ธ ุญุฐู ุงูููู ุงููุฏูู: $ASSET_ID"
                curl -X DELETE \
                  -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                  "https://api.github.com/repos/${{ github.repository }}/releases/assets/$ASSET_ID"
                echo "โ ุชู ุญุฐู ุงูููู ุงููุฏูู"
              fi
            else
              echo "โน๏ธ ูุง ููุฌุฏ ุฅุตุฏุงุฑ ุณุงุจูุ ุณูุชู ุฅูุดุงุก ุฅุตุฏุงุฑ ุฌุฏูุฏ"
            fi
            
            # ุฅูุดุงุก ุฃู ุชุญุฏูุซ ุงูุฅุตุฏุงุฑ ูุฑูุน ุงูููู
            echo "๐ค ุฑูุน ุงูููู ุฅูู Release..."
            
            # ุงุณุชุฎุฏุงู GitHub CLI ูุฑูุน ุงูููู
            gh release create "$RELEASE_NAME" "$APK_FILE" \
              --title "$RELEASE_NAME" \
              --notes "ุชู ุฑูุน $FILENAME ุชููุงุฆูุงู ูู ุงููุณุชูุฏุน" \
              --repo "${{ github.repository }}" \
              || gh release upload "$RELEASE_NAME" "$APK_FILE" --clobber \
              --repo "${{ github.repository }}"
            
            echo "โ ุชู ุฑูุน $FILENAME ุจูุฌุงุญ!"
            echo "๐ ุฑุงุจุท ุงูุฅุตุฏุงุฑ: https://github.com/${{ github.repository }}/releases/tag/$RELEASE_NAME"
            echo ""
            
          done < apk_list.txt
          
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "๐ ุงูุชููุช ุงูุนูููุฉ ุจูุฌุงุญ!"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ุนุฑุถ ููุฎุต ุงููุชุงุฆุฌ
        if: steps.detect.outputs.has_apk == 'true'
        run: |
          echo "## ๐ ููุฎุต ุงูุฑูุน" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| ุงุณู ุงูููู | ุงุณู ุงูุฅุตุฏุงุฑ | ุงูุญุงูุฉ |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-------------|--------|" >> $GITHUB_STEP_SUMMARY
          
          while IFS= read -r APK_FILE; do
            APK_FILE=${APK_FILE#./}
            FILENAME=$(basename "$APK_FILE")
            RELEASE_NAME="${FILENAME%.apk}"
            echo "| $FILENAME | $RELEASE_NAME | โ ูุฌุญ |" >> $GITHUB_STEP_SUMMARY
          done < apk_list.txt
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "๐ [ุนุฑุถ ุฌููุน ุงูุฅุตุฏุงุฑุงุช](https://github.com/${{ github.repository }}/releases)" >> $GITHUB_STEP_SUMMARY
