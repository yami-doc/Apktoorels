name: Upload APK to Release

on:
  workflow_dispatch:
    inputs:
      apk_url:
        description: "ุฑุงุจุท ููู APK ูู ุฃู ูุตุฏุฑ (catboxุ GitHubุ ุฅูุฎ)"
        required: true
      release_name:
        description: "ุงุณู ุงูุฅุตุฏุงุฑ ูุซู radio ุฃู azkar"
        required: true
      apk_filename:
        description: "ุงุณู ููู APK (ูุซู: radio ุฃู azkar-v2)"
        required: true

jobs:
  upload:
    runs-on: ubuntu-latest
    steps:
      - name: ุชูุฒูู ููู APK
        run: |
          mkdir -p temp
          cd temp
          
          # ุฅุถุงูุฉ .apk ุชููุงุฆูุงู ุฅุฐุง ูู ููู ููุฌูุฏุงู
          FILENAME="${{ github.event.inputs.apk_filename }}"
          if [[ ! "$FILENAME" =~ \.apk$ ]]; then
            FILENAME="${FILENAME}.apk"
          fi
          echo "APK_FILENAME=$FILENAME" >> $GITHUB_ENV
          
          # ุงุณุชุฎุฏุงู curl ุจุฏูุงู ูู wget ูุฏุนู ุฃูุถู ูุฅุนุงุฏุฉ ุงูุชูุฌูู
          echo "ุฌุงุฑู ุชูุฒูู ุงูููู ูู: ${{ github.event.inputs.apk_url }}"
          
          # ุชูุฒูู ุงูููู ูุน ูุชุงุจุนุฉ ุฅุนุงุฏุฉ ุงูุชูุฌูู ูุนุฑุถ ุงูุชูุฏู
          curl -L \
            --fail \
            --retry 3 \
            --retry-delay 2 \
            --max-time 300 \
            --progress-bar \
            -o "$FILENAME" \
            "${{ github.event.inputs.apk_url }}"
          
          # ุงูุชุญูู ูู ูุฌุงุญ ุงูุชูุฒูู
          if [ ! -f "$FILENAME" ]; then
            echo "โ ูุดู ุชูุฒูู ุงูููู"
            exit 1
          fi
          
          # ุงูุชุญูู ูู ุญุฌู ุงูููู
          FILE_SIZE=$(stat -f%z "$FILENAME" 2>/dev/null || stat -c%s "$FILENAME" 2>/dev/null)
          if [ "$FILE_SIZE" -lt 1000 ]; then
            echo "โ ุงูููู ุงููุญููู ุตุบูุฑ ุฌุฏุงูุ ูุฏ ูููู ููุงู ุฎุทุฃ"
            exit 1
          fi
          
          echo "โ ุชู ุชูุฒูู ุงูููู ุจูุฌุงุญ - ุงูุญุฌู: $FILE_SIZE ุจุงูุช"

      - name: ุงูุชุญูู ูู ููุน ุงูููู
        run: |
          cd temp
          # ุงูุชุญูู ูู ุฃู ุงูููู ูู APK ูุนูุงู
          file "${{ env.APK_FILENAME }}"
          
          # ูุญุงููุฉ ูุฑุงุกุฉ ุชูููุน ZIP (APK ูู ููู ZIP)
          if ! head -c 4 "${{ env.APK_FILENAME }}" | grep -q "PK"; then
            echo "โ๏ธ ุชุญุฐูุฑ: ุงูููู ูุฏ ูุง ูููู APK ุตุญูุญ"
          else
            echo "โ ุงูููู ูุจุฏู ูููู APK ุตุญูุญ"
          fi

      - name: ุญุฐู ุงูููู ุงููุฏูู ุฅุฐุง ูุงู ููุฌูุฏุงู
        continue-on-error: true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # ุงูุญุตูู ุนูู ูุนูููุงุช ุงูุฅุตุฏุงุฑ
          RELEASE_ID=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/releases/tags/${{ github.event.inputs.release_name }}" \
            | jq -r '.id')
          
          if [ "$RELEASE_ID" != "null" ] && [ -n "$RELEASE_ID" ]; then
            echo "โ ุชู ุงูุนุซูุฑ ุนูู ุงูุฅุตุฏุงุฑ: $RELEASE_ID"
            
            # ุงูุจุญุซ ุนู ุงูููู ุจููุณ ุงูุงุณู
            ASSET_ID=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/${{ github.repository }}/releases/$RELEASE_ID/assets" \
              | jq -r ".[] | select(.name==\"${{ env.APK_FILENAME }}\") | .id")
            
            if [ -n "$ASSET_ID" ] && [ "$ASSET_ID" != "null" ]; then
              echo "๐๏ธ ุชู ุงูุนุซูุฑ ุนูู ููู ูุฏูู ุจููุณ ุงูุงุณู: $ASSET_ID"
              echo "ุฌุงุฑู ุญุฐู ุงูููู ุงููุฏูู..."
              
              curl -X DELETE \
                -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                "https://api.github.com/repos/${{ github.repository }}/releases/assets/$ASSET_ID"
              
              echo "โ ุชู ุญุฐู ุงูููู ุงููุฏูู ุจูุฌุงุญ"
            else
              echo "โน๏ธ ูุง ููุฌุฏ ููู ูุฏูู ุจููุณ ุงูุงุณู"
            fi
          else
            echo "โน๏ธ ูุง ููุฌุฏ ุฅุตุฏุงุฑ ุจูุฐุง ุงูุงุณูุ ุณูุชู ุฅูุดุงุก ุฅุตุฏุงุฑ ุฌุฏูุฏ"
          fi

      - name: ุฑูุน ุงูููู ุฅูู Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event.inputs.release_name }}
          name: ${{ github.event.inputs.release_name }}
          files: temp/${{ env.APK_FILENAME }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ุนุฑุถ ูุนูููุงุช ุงูุฅุตุฏุงุฑ
        run: |
          echo "๐ ุชู ุฑูุน ุงูููู ุจูุฌุงุญ!"
          echo "๐ฆ ุงุณู ุงูููู: ${{ env.APK_FILENAME }}"
          echo "๐ท๏ธ ุงุณู ุงูุฅุตุฏุงุฑ: ${{ github.event.inputs.release_name }}"
          echo "๐ ุฑุงุจุท ุงูุฅุตุฏุงุฑ: https://github.com/${{ github.repository }}/releases/tag/${{ github.event.inputs.release_name }}"
